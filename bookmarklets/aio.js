javascript:(()=>{var L=21;var X="Jessidhia/hensei-transfer";async function N(){let e=new Date().getTime();try{if(await(await fetch(`https://raw.githubusercontent.com/${X}/main/version.json?_=${e}`)).json()>L&&confirm("hensei-transfer has received an update. Please re-download the bookmarklet to ensure it's compatible with the latest changes, or click Cancel to proceed anyway."))return open(`https://github.com/${X}`,"_blank"),!1}catch(n){console.error(n)}return!0}function R(){return Game}function O({view:{deck_model:{attributes:{deck:{name:e,pc:n,npc:t}}}},lang:a}){return{lang:a,name:e,class:n.job.master.name,extra:n.isExtraDeck,friend_summon:n.damage_info.summon_name,accessory:n.familiar_id||n.shield_id,subskills:pe(n.set_action),characters:de(t),weapons:be(n.weapons),summons:z(n.summons,n.quick_user_summon_id),sub_summons:z(n.sub_summons)}}function pe(e){return e.map(n=>"name"in n?n.name:null)}function de(e){return Object.values(e).filter(K).map(({master:n,param:t})=>{let a={name:n.name,id:n.id,uncap:parseInt(t.evolution,10)};t.has_npcaugment_constant&&(a.ringed=!0);let r=parseInt(t.phase,10);return r>0&&(a.transcend=r),a})}function be(e){let n=[40,60,80,100,150,200],t=[210,220,230,240],a=[[13],[3,13,19,27,40],[3,13,27,40]],r=[13,17,19];return Object.values(e).filter(K).map(({master:i,param:g,...w})=>{let P=parseInt(i.id,10),x=parseInt(i.series_id,10),m=parseInt(i.attribute,10),p=r.includes(x),f=parseInt(g.level,10),u=n.reduce((o,b)=>f>b?o+1:o,0),l={name:i.name,attr:p?m:void 0,id:p?`${P-(m-1)*100}`:i.id,uncap:u};u>5&&(l.transcend=t.reduce((o,b)=>f>b?o+1:o,1));let{arousal:s}=g;s.is_arousal_weapon&&s.form_name&&(l.awakening={type:s.form_name,lvl:s.level});let d=g.augment_skill_info;if(d.length!=0){let o=d[0];l.ax=o.map(({skill_id:b,show_value:y})=>({id:`${b}`,val:y}))}let c=[];for(let[o,b]of a.entries())if(b.includes(x)){let y=`skill${o+1}`;w[y]&&c.push(w[y].id)}return c.length>0&&(l.keys=c),l})}function z(e,n){let t=[210,220,230,240];return Object.values(e).filter(K).map(({master:a,param:r})=>{let i=parseInt(r.evolution,10),g={name:a.name,id:a.id,uncap:i};if(i>5){let w=parseInt(r.level,10);g.transcend=t.reduce((P,x)=>w>x?P+1:P,1)}return n&&r.id==`${n}`&&(g.qs=!0),g})}function K(e){return e.master!==null&&e.param!==null}function Y(e){let n=document.body.appendChild(document.createElement("textarea"));n.textContent=e,n.select(),document.execCommand("copy"),n.remove()}function Q(e="Paste your Export here"){return prompt(e)}function ee(e,n){return(Array.isArray(e)?e:[e]).some(a=>{let[r,i]=t(a);return n>=r&&n<=i});function t(a){let r=/^(\d+)(?:-(\d+))?$/.exec(a),i=parseInt(r[1],10);return[i,r[2]?parseInt(r[2],10):i]}}var ge=[2,3,4,1,6,5];function ne(e){return ge[e-1]}var ye={1588:7,1589:0,1590:1,1591:3,1592:4,1593:9,1594:13,1595:10,1596:5,1597:6,1599:8,1600:12,1601:11,1719:15,1720:16,1721:17,1722:14};function J(e){return ye[e]}var _e={1:[],2:[],3:["1050"],13001:["1240","2204","2208"],13002:["1241","2205","2209"],13003:["1242","2206","2210"],13004:["1243","2207","2211"],14001:["502-507","1213-1218"],14002:["130-135","71-76"],14003:["1260-1265","1266-1271"],14004:["1199-1204","1205-1210"],14011:["322-327","1310-1315"],14012:["764-769","1731-1735","948"],14013:["1171-1176","1736-1741"],14014:"1723",14015:"1724",14016:"1725",14017:"1726",10001:"697-706",10002:"707-716",10003:"717-726",10004:"727-736",10005:"737-746",10006:"747-756",11001:"758",11002:"759",11003:"760",11004:"761",17001:"1807",17002:"1808",17003:"1809",17004:"1810",15001:"1446",15002:"1447",15003:"1448",15004:"1449",15005:"1450",15006:"1451",15007:"1452",16001:"1228-1233",16002:"1234-1239",15008:"2043-2048",15009:"2049-2055",14005:"2212-2223",14006:"2224-2235",14007:"2236-2247"};function $(e,n){let t=parseInt(n,10);return e.find(a=>{let r=_e[a.granblue_id];return r&&ee(r,t)})}var xe={24:[19]};function T(e){for(let[n,t]of Object.entries(xe))if(t.includes(e))return parseInt(n,10);return e}var ke="https://hensei-api-production-66fb.up.railway.app";function H(){return!!te()}function te(){let e=location.hostname.endsWith("granblue.team")&&document.cookie.match(new RegExp("token%22%3A%22(.+?)%22"));if(e)return e[1]}function q(e){return j("GET",e)}function ae(e,n,t,a){return j("PUT",`${e}/${n}${t?`/${t}`:""}`,a)}function v(e,n){return j("POST",e,n)}async function j(e,n,t,a=!1){return(await fetch(`${ke}/api/v1/${n}`,{method:e,headers:{"content-type":"application/json",...a?null:{authorization:`Bearer ${te()}`}},body:t&&JSON.stringify(t)})).json()}async function M(e,n,t){for await(let a of we(e,n))if(await t(a))return a}var he=3;async function*we(e,n){let t=await j("POST",`search/${e}`,{search:n},!H());yield*t.results;let{meta:{total_pages:a}}=t,r=Math.min(a,he);for(let i=2;i<=r;i++)yield*(await j("POST",`search/${e}`,{search:{...n,page:i}},!H())).results}function Se(){return __NEXT_DATA__.props.pageProps.context}function re(e,n,t){return $(D(n,t),e)}function D(e,n){let t=Se().weaponKeys;if(!t)return[];let a=typeof e=="number"?T(e):0,r=typeof e=="string"?t[e]:typeof e=="number"?Object.values(t).flat().filter(i=>i.series.includes(a)):Object.values(t).flat();return n===void 0?r:r.filter(i=>i.slot==n)}function ie(e={}){return v("parties",e)}async function I(e,n,t){let a=await v(e,t);return a&&typeof a=="object"&&"conflicts"in a?v(`${e}/resolve`,{resolve:{conflicting:[a.conflicts[0].id],incoming:a.incoming.id,position:n}}):a}function h(e,n,t,a){return ae(e,n,t,a)}function se(e,n,t,a){return v(`${e}/update_uncap`,{[e.slice(0,-1)]:{id:n,uncap_level:a?6:t,transcendence_step:a||0}})}function U(e,n,t,a={}){return M(e,{query:n,locale:t,...a},r=>r.name[t]===n)}function E(e,n,t){return M(e,t,a=>a.granblue_id===n)}async function oe(e,n){let t=`${n}`;return(await q(`jobs/${e}/accessories`)).find(a=>a.granblue_id===t)}async function ue(e,n,t){let a=re(e,n,t);return a||(typeof n=="number"?$(await He(T(n),t),e):void 0)}async function He(e,n){let t=new URLSearchParams({series:`${T(e)}`});n!==void 0&&t.append("slot",`${n}`);let a=D(e,n);return a.length>0?a:q(`weapon_keys?${t.toString()}`)}async function F(){let{context:e}=__NEXT_DATA__.props.pageProps;if(e==null){alert("Please refresh the page to load important data, then try again.");return}if(e.jobs==null){alert("Some data needed to create a team is missing, please open a team that already exists and press F5, and then run the script again. This will not overwrite your team. You can offset this by bookmarking the New team page and running the script from there.");return}if(!H()){alert("This import script only works for logged-in users, please log-in or create an account.");return}let n=Q();if(!n||n.length==0)return;let t=JSON.parse(n);document.body.style.setProperty("cursor","wait","important");let a=document.querySelector('nav[class^="Header_header__"]'),r=document.createElement("span");r.style.cssText="color: cyan; font-size: 22px;",r.innerText="Loading your team... this may take a bit",a?.insertBefore(r,a?.lastElementChild);let i;try{let{party:m}=await ie({name:t.name,extra:t.extra,visibility:2});i=m.id,await Promise.all([g(),w(),P(),x(t.friend_summon,t.summons,0),x(void 0,t.sub_summons,5)]),document.body.style.cursor="",r.remove(),location.assign(`/p/${m.shortcode}`)}catch(m){throw r.style.color="red",r.innerText="An error occurred, check browser console",m}async function g(){let{class:m,subskills:p,accessory:f}=t,u=e.jobs.find(s=>s.name[t.lang]===m)?.id,l=new Set;if(u){if(await h("parties",i,"jobs",{party:{job_id:u}}),p.length>0){let s=await Promise.all(p.map(async c=>c&&(await U("job_skills",c,t.lang,{job:u}))?.id)),d={};for(let[c,o]of s.filter(b=>!!b).entries())d[`skill${c+1}_id`]=o;l.add(h("parties",i,"job_skills",{party:d}))}if(f){let s=(await oe(u,f))?.id;s&&l.add(h("parties",i,"",{party:{accessory_id:s}}))}}await l}async function w(){let{characters:m}=t,p=new Set;for(let[f,{name:u,id:l,uncap:s,ringed:d=!1,transcend:c}]of m.entries()){let o=(await E("characters",l,{query:u,locale:t.lang}))?.id;o&&p.add(I("characters",f,{character:{character_id:o,party_id:i,position:f,perpetuity:d,uncap_level:c?6:s,transcendence_step:c}}))}await Promise.all(p)}async function P(){let{weapons:m}=t,p=new Set;for(let[f,{name:u,id:l,uncap:s,attr:d,transcend:c,awakening:o,keys:b,ax:y}]of m.entries()){let S=(await E("weapons",l,{query:u,locale:t.lang}))?.id;if(S){let le=f==0,V=f-1,{grid_weapon:C}=await I("weapons",V,{weapon:{weapon_id:S,party_id:i,position:V,mainhand:le,uncap_level:c?6:s,transcendence_step:c,...d!==void 0?{element:ne(d)}:null}}),W=C.id;if(o){let{type:k,lvl:_}=o,G=C.object.awakenings.find(({name:{[t.lang]:ce}})=>ce===k);G&&p.add(h("grid_weapons",W,"",{weapon:{awakening_id:G.id,awakening_level:_}}))}if(b){let{series:k}=C.object;for(let[_,A]of b.entries()){if(!A)continue;let G=(await ue(A,k,_))?.id;p.add(h("grid_weapons",W,"",{weapon:{[`weapon_key${_+1}_id`]:G}}))}}if(y){let[k,_]=y;p.add(h("grid_weapons",W,"",{weapon:{...k&&{ax_modifier1:J(k.id),ax_strength1:parseInt(k.val.replace("+","").replace("%",""),10)},..._&&{ax_modifier2:J(_.id),ax_strength2:parseInt(_.val.replace("+","").replace("%",""),10)}}}))}}}await Promise.all(p)}async function x(m,p,f){for(let[u,{name:l,id:s,uncap:d,transcend:c=0,qs:o=!1}]of p.entries()){let b=(await E("summons",s,{query:l,locale:t.lang}))?.id;if(b){let y=f==0&&u==0,S=u+f;await I("summons",S,{summon:{summon_id:b,party_id:i,position:S-1,main:y,friend:!1,uncap_level:c>0?6:d,transcendence_step:c,quick_summon:o}})}}if(m){let u=(await U("summons",m,t.lang))?.id;if(u){let{grid_summon:{id:l,object:{uncap:s}}}=await I("summons",6,{summon:{summon_id:u,party_id:i,position:6,main:!1,friend:!0,uncap_level:0}}),d=s.transcendence?6:s.ulb?5:s.flb?4:3;await se("summons",l,d,d==6?5:0)}}}}N().then(e=>{if(e){if(location.hostname.endsWith("granblue.team"))return F();if(location.hostname.endsWith("game.granbluefantasy.jp")){let n=JSON.stringify(O(R()));Y(n),confirm("Copied team data to clipboard! If you press OK, a new tab in granblue.team will be open now - click the bookmark again on it and paste your data in there.")&&open("https://granblue.team","_blank")}else alert("Can only be used in game.granbluefantasy.jp or granblue.team")}});})();
