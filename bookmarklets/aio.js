javascript:(()=>{var Z=20;var ee="Jessidhia/hensei-transfer";async function V(){let t=new Date().getTime();try{if(await(await fetch(`https://raw.githubusercontent.com/${ee}/main/version.json?_=${t}`)).json()>Z&&confirm("hensei-transfer has received an update. Please re-download the bookmarklet to ensure it's compatible with the latest changes, or click Cancel to proceed anyway."))return open(`https://github.com/${ee}`,"_blank"),!1}catch(n){console.error(n)}return!0}function L(){return Game}function K({view:{deck_model:{attributes:{deck:{name:t,pc:n,npc:g}}}},lang:a}){return{lang:a,name:t,class:n.job.master.name,extra:n.isExtraDeck,friend_summon:n.damage_info.summon_name,accessory:n.familiar_id||n.shield_id,subskills:ue(n.set_action),characters:ce(g),weapons:me(n.weapons),summons:ne(n.summons,n.quick_user_summon_id),sub_summons:ne(n.sub_summons)}}function ue(t){return t.map(n=>"name"in n?n.name:null)}function ce(t){return Object.values(t).filter(z).map(({master:n,param:g})=>{let a={name:n.name,id:n.id,uncap:parseInt(g.evolution,10)};g.has_npcaugment_constant&&(a.ringed=!0);let c=parseInt(g.phase,10);return c>0&&(a.transcend=c),a})}function me(t){let n=[40,60,80,100,150,200],g=[210,220,230,240],a=[[13],[3,13,19,27,40],[3,13,27,40]],c=[13,17,19];return Object.values(t).filter(z).map(({master:o,param:u,...G})=>{let T=parseInt(o.id,10),j=parseInt(o.series_id,10),q=parseInt(o.attribute,10),A=c.includes(j),C=parseInt(u.level,10),N=n.reduce((k,l)=>C>l?k+1:k,0),x={name:o.name,attr:A?q:void 0,id:A?`${T-(q-1)*100}`:o.id,uncap:N};N>5&&(x.transcend=g.reduce((k,l)=>C>l?k+1:k,1));let{arousal:h}=u;h.is_arousal_weapon&&h.form_name&&(x.awakening={type:h.form_name,lvl:h.level});let v=u.augment_skill_info;if(v.length!=0){let k=v[0];x.ax=k.map(({skill_id:l,show_value:y})=>({id:`${l}`,val:y}))}let R=[];for(let[k,l]of a.entries())if(l.includes(j)){let y=`skill${k+1}`;G[y]&&R.push(G[y].id)}return R.length>0&&(x.keys=R),x})}function ne(t,n){let g=[210,220,230,240];return Object.values(t).filter(z).map(({master:a,param:c})=>{let o=parseInt(c.evolution,10),u={name:a.name,id:a.id,uncap:o};if(o>5){let G=parseInt(c.level,10);u.transcend=g.reduce((T,j)=>G>j?T+1:T,1)}return n&&c.id==`${n}`&&(u.qs=!0),u})}function z(t){return t.master!==null&&t.param!==null}function ae(t){let n=document.body.appendChild(document.createElement("textarea"));n.textContent=t,n.select(),document.execCommand("copy"),n.remove()}function te(t="Paste your Export here"){return prompt(t)}function se(t,n){return(Array.isArray(t)?t:[t]).some(a=>{let[c,o]=g(a);return n>=c&&n<=o});function g(a){let c=/^(\d+)(?:-(\d+))?$/.exec(a),o=parseInt(c[1],10);return[o,c[2]?parseInt(c[2],10):o]}}var pe="https://hensei-api-production-66fb.up.railway.app";async function B(){let{context:t}=__NEXT_DATA__.props.pageProps;if(t==null){alert("Please refresh the page to load important data, then try again.");return}if(t.jobs==null){alert("Some data needed to create a team is missing, please open a team that already exists and press F5, and then run the script again. This will not overwrite your team. You can offset this by bookmarking the New team page and running the script from there.");return}let n=R();if(!n){alert("This import script only works for logged-in users, please log-in or create an account.");return}let g=te();if(!g||g.length==0)return;let a=JSON.parse(g);document.body.style.setProperty("cursor","wait","important");let c=document.querySelector('nav[class^="Header_header__"]'),o=document.createElement("span");o.style.cssText="color: cyan; font-size: 22px;",o.innerText="Loading your team... this may take a bit",c?.insertBefore(o,c?.lastElementChild);let u;try{let e;({id:u,redirect:e}=await G()),await Promise.all([T(),await j(),await q(),await A(),await C(a.friend_summon,a.summons,0),await C(void 0,a.sub_summons,5)]),document.body.style.cursor="",o.remove(),location.assign(e)}catch(e){throw o.style.color="red",o.innerText="An error occurred, check browser console",e}async function G(){let{party:{id:e,shortcode:r}}=await y("parties",{});return{id:e,redirect:`/p/${r}`}}function T(){let{name:e,extra:r}=a;return l("parties",u,"",{party:{name:e,extra:r}})}async function j(){let{class:e,subskills:r,accessory:s}=a,i=await v(t.jobs,d=>d.name[a.lang]===e),m=new Set;if(i.length>0){if(await l("parties",u,"jobs",{party:{job_id:i}}),r.length>0){let d=await Promise.all(r.map(p=>p&&h("job_skills",{query:p,job:i,locale:a.lang},b=>b.name[a.lang]==p))),f={};for(let[p,b]of d.filter(w=>!!w).entries())f[`skill${p+1}_id`]=b;let _=new Set;for(let[p,b]of Object.entries(f)){let w={[p]:b};"code"in await l("parties",u,"job_skills",{party:w})&&_.add(w)}for(let p of _)m.add(l("parties",u,"job_skills",{party:p}))}if(s){let d=await k(`jobs/${i}/accessories`),f=v(d,_=>_.granblue_id==`${s}`);await l("parties",u,"",{party:{accessory_id:f}})}}await m}async function q(){let{characters:e}=a,r=new Set;for(let[s,{name:i,id:m,uncap:d,ringed:f=!1,transcend:_}]of e.entries()){let p=await h("characters",{query:i,locale:a.lang},b=>b.granblue_id==m);if(p.length>0){let{id:b}=await x("characters",s,{character:{character_id:p,party_id:u,position:s,uncap_level:d}});f&&r.add(l("grid_characters",b,"",{character:{perpetuity:!0}})),_&&r.add(l("grid_characters",b,"",{character:{uncap_level:6,transcendence_step:_}}))}}await Promise.all(r)}async function A(){let{weapons:e}=a,r=[2,3,4,1,6,5],s={k13001:["1240","2204","2208"],k13002:["1241","2205","2209"],k13003:["1242","2206","2210"],k13004:["1243","2207","2211"],k14014:"1723",k14015:"1724",k14016:"1725",k14017:"1726",k10001:"697-706",k10002:"707-716",k10003:"717-726",k10004:"727-736",k10005:"737-746",k10006:"747-756",k11001:"758",k11002:"759",k11003:"760",k11004:"761",k17001:"1807",k17002:"1808",k17003:"1809",k17004:"1810",k15001:"1446",k15002:"1447",k15003:"1448",k15004:"1449",k15005:"1450",k15006:"1451",k15007:"1452",k16001:"1228-1233",k16002:"1234-1239",k14001:["502-507","1213-1218"],k14002:["130-135","71-76"],k14003:["1260-1265","1266-1271"],k14004:["1199-1204","1205-1210"],k14011:["322-327","1310-1315"],k14012:["764-769","1731-1735","948"],k14013:["1171-1176","1736-1741"],k15008:"2043-2048",k15009:"2049-2055",k14005:"2212-2223",k14006:"2224-2235",k14007:"2236-2247"},i={ax1588:7,ax1589:0,ax1590:1,ax1591:3,ax1592:4,ax1593:9,ax1594:13,ax1595:10,ax1596:5,ax1597:6,ax1599:8,ax1600:12,ax1601:11,ax1719:15,ax1720:16,ax1721:17,ax1722:14},m=new Set;for(let[d,{name:f,id:_,uncap:p,attr:b,transcend:w,awakening:I,keys:H,ax:F}]of e.entries()){let X=await h("weapons",{query:f,locale:a.lang},function(U){return U.granblue_id==_});if(X.length>0){let U=d==0,Y=d-1,{grid_weapon:M}=await x("weapons",Y,{weapon:{weapon_id:X,party_id:u,position:Y,mainhand:U,uncap_level:p}}),O=M.id;if(b!==void 0&&m.add(l("grid_weapons",O,"",{weapon:{element:r[b-1]}})),w&&m.add(l("grid_weapons",O,"",{weapon:{uncap_level:6,transcendence_step:w}})),I){let{type:$,lvl:P}=I,E=M.object.awakenings.find(({name:{[a.lang]:W}})=>W===$);E&&m.add(y("weapons/update_uncap",{weapon:{id:O,awakening_id:E.id,awakening_level:P}}))}if(H){let{series:$}=M.object;for(let[P,S]of H.entries()){if(!S)continue;let E=await k(`weapon_keys?series=${encodeURIComponent($)}&slot=${encodeURIComponent(P)}`),W=v(E,({granblue_id:D})=>{let Q=`k${D}`,ie=parseInt(S,10);if(Q in s){let oe=s[Q];return se(oe,ie)}return!1});m.add(l("grid_weapons",O,"",{weapon:{[`weapon_key${P+1}_id`]:W}}))}}if(F){let $={};for(let[P,S]of F.entries()){let E=S.id,W=i[`ax${E}`],D=P+1;$[`ax_modifier${D}`]=W,$[`ax_strength${D}`]=parseInt(S.val.replace("+","").replace("%",""))}m.add(l("grid_weapons",O,"",{weapon:$}))}}}await Promise.all(m)}async function C(e,r,s){for(let[i,{name:m,id:d,uncap:f,transcend:_=0,qs:p=!1}]of r.entries()){let b=await h("summons",{query:m,locale:a.lang},function(w){return w.granblue_id==d});if(b.length>0){let w=s==0&&i==0,I=i-1+s,{grid_summon:{id:H}}=await x("summons",I,{summon:{summon_id:b,party_id:u,position:I,main:w,friend:!1,uncap_level:f}});_>0&&await N(H,6,_),p&&await y("summons/update_quick_summon",{summon:{id:H,quick_summon:!0}})}}if(e){let i=await h("summons",{query:e,locale:a.lang},m=>m.name[a.lang]==e);if(i.length>0){let{grid_summon:{id:m,object:{uncap:d}}}=await x("summons",6,{summon:{summon_id:i,party_id:u,position:6,main:!1,friend:!0,uncap_level:0}}),f=d.xlb?6:d.ulb?5:d.flb?4:3,_=f==6?5:0;await N(m,f,_)}}}function N(e,r,s){return y("summons/update_uncap",{summon:{id:e,uncap_level:r,transcendence_step:s}})}async function x(e,r,s){let i=await y(e,s);return"conflicts"in i?y(`${e}/resolve`,{resolve:{conflicting:[i.conflicts[0].id],incoming:i.incoming.id,position:r}}):i}async function h(e,r,s){let{results:i}=await y(`search/${e}`,{search:r});return v(i,s)}function v(e,r){if(!e||e.length==0)return"";let s=Array.from("length"in e?e:Object.values(e)).find(r);return s?s.id:e[0].id}function R(){let e=document.cookie.match(new RegExp("token%22%3A%22(.+?)%22"));if(e)return e[1]}function k(e){return J("GET",e)}function l(e,r,s,i){return J("PUT",`${e}/${r}/${s}`,i)}function y(e,r){return J("POST",e,r)}async function J(e,r,s){return(await fetch(`${pe}/api/v1/${r}`,{method:e,headers:{"content-type":"application/json",authorization:`Bearer ${n}`},body:s&&JSON.stringify(s)})).json()}}V().then(t=>{if(t){if(location.hostname.endsWith("granblue.team"))return B();if(location.hostname.endsWith("game.granbluefantasy.jp")){let n=JSON.stringify(K(L()));ae(n),confirm("Copied team data to clipboard! If you press OK, a new tab in granblue.team will be open now - click the bookmark again on it and paste your data in there.")&&open("https://granblue.team","_blank")}else alert("Can only be used in game.granbluefantasy.jp or granblue.team")}});})();
